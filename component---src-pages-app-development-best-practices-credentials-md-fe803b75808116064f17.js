"use strict";(self.webpackChunkcommerce_extensibility=self.webpackChunkcommerce_extensibility||[]).push([[7730],{31019:function(e,t,n){n.r(t),n.d(t,{_frontmatter:function(){return o},default:function(){return l}});var a=n(58168),i=n(80045),r=(n(88763),n(15680)),s=n(83407);const c=["components"],o={},d={_frontmatter:o},p=s.A;function l(e){let{components:t}=e,n=(0,i.A)(e,c);return(0,r.mdx)(p,(0,a.A)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.mdx)("h1",{id:"credentials-management"},"Credentials management"),(0,r.mdx)("p",null,"App Builder is an excellent framework for building integrations that connect Commerce to 3rd-party systems like Amazon or ERPs. These systems often require credentials to support your application to securely communicate and update them."),(0,r.mdx)("p",null,"The Amazon Sales Channel app requires credentials and secrets to perform certain actions and interact with the Amazon API. These items must be changed every 180 days to comply with Amazon standards, and they could be updated in runtime. Therefore, creating a static set of credentials is not an option."),(0,r.mdx)("p",null,"This topic describes the method the development team used to safely store these credentials in a way that allows for easy updating when necessary."),(0,r.mdx)("h2",{id:"use-case"},"Use case"),(0,r.mdx)("p",null,"The development team chose to implement a cypher algorithm to safely store and retrieve these credentials. This algorithm encrypts the credentials of each store using a unique vector that is randomly generated when the store is created."),(0,r.mdx)("p",null,"The merchant enters credentials and secrets when creating a new store through the Admin using the ",(0,r.mdx)("strong",{parentName:"p"},"Add Amazon Store")," menu."),(0,r.mdx)("p",null,(0,r.mdx)("span",{parentName:"p",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1280px"}},"\n      ",(0,r.mdx)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"123.75%",position:"relative",bottom:"0",left:"0",display:"block",transition:"opacity 0.5s 0.5s",pointerEvents:"none"}}),"\n  ",(0,r.mdx)("picture",{parentName:"span"},"\n          ",(0,r.mdx)("source",{parentName:"picture",srcSet:["/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/5530d/add-amazon-sales-channel.webp 320w","/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/0c8fb/add-amazon-sales-channel.webp 640w","/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/94b1e/add-amazon-sales-channel.webp 1280w","/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/b2fee/add-amazon-sales-channel.webp 1282w"],sizes:"(max-width: 1280px) 100vw, 1280px",type:"image/webp"}),"\n          ",(0,r.mdx)("source",{parentName:"picture",srcSet:["/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/dd4a7/add-amazon-sales-channel.png 320w","/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/0f09e/add-amazon-sales-channel.png 640w","/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/bbbf7/add-amazon-sales-channel.png 1280w","/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/018c1/add-amazon-sales-channel.png 1282w"],sizes:"(max-width: 1280px) 100vw, 1280px",type:"image/png"}),"\n          ",(0,r.mdx)("img",{parentName:"picture",className:"gatsby-resp-image-image",src:"/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/bbbf7/add-amazon-sales-channel.png",alt:"Add Amazon Sales Channel form",title:"Add Amazon Sales Channel form",loading:"lazy",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",opacity:"0",transition:"opacity 0.5s",color:"inherit",boxShadow:"inset 0px 0px 0px 400px none",top:"0",left:"0"}}),"\n        "),"\n    ")),(0,r.mdx)("p",null,"Once the merchant completes the form, an action is triggered to randomly generate an initialization vector specific to the new account and to store the account information. It's important that the initialization vector is generated in the backend so that it's not visible from the UI."),(0,r.mdx)("p",null,"This vector is then used in another action that encrypts the credentials and stores them in the ",(0,r.mdx)("a",{parentName:"p",href:"https://github.com/adobe/aio-lib-files"},(0,r.mdx)("inlineCode",{parentName:"a"},"lib-file")," storage system"),". To use or update the credentials, they must be retrieved from ",(0,r.mdx)("inlineCode",{parentName:"p"},"lib-file")," and decrypted with the same vector used for encryption."),(0,r.mdx)("p",null,"The following diagram describes the generic flow of the credential storage and encryption process."),(0,r.mdx)("p",null,(0,r.mdx)("span",{parentName:"p",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1243px"}},"\n      ",(0,r.mdx)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"62.18749999999999%",position:"relative",bottom:"0",left:"0",display:"block",transition:"opacity 0.5s 0.5s",pointerEvents:"none"}}),"\n  ",(0,r.mdx)("picture",{parentName:"span"},"\n          ",(0,r.mdx)("source",{parentName:"picture",srcSet:["/commerce-extensibility/static/eb9bde6faee475e008ef9c8f7cce25cf/5530d/credentials-flow.webp 320w","/commerce-extensibility/static/eb9bde6faee475e008ef9c8f7cce25cf/0c8fb/credentials-flow.webp 640w","/commerce-extensibility/static/eb9bde6faee475e008ef9c8f7cce25cf/f2a99/credentials-flow.webp 1243w"],sizes:"(max-width: 1243px) 100vw, 1243px",type:"image/webp"}),"\n          ",(0,r.mdx)("source",{parentName:"picture",srcSet:["/commerce-extensibility/static/eb9bde6faee475e008ef9c8f7cce25cf/dd4a7/credentials-flow.png 320w","/commerce-extensibility/static/eb9bde6faee475e008ef9c8f7cce25cf/0f09e/credentials-flow.png 640w","/commerce-extensibility/static/eb9bde6faee475e008ef9c8f7cce25cf/2c0f3/credentials-flow.png 1243w"],sizes:"(max-width: 1243px) 100vw, 1243px",type:"image/png"}),"\n          ",(0,r.mdx)("img",{parentName:"picture",className:"gatsby-resp-image-image",src:"/commerce-extensibility/static/eb9bde6faee475e008ef9c8f7cce25cf/2c0f3/credentials-flow.png",alt:"Credentials storage and encryption flow",title:"Credentials storage and encryption flow",loading:"lazy",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",opacity:"0",transition:"opacity 0.5s",color:"inherit",boxShadow:"inset 0px 0px 0px 400px none",top:"0",left:"0"}}),"\n        "),"\n    ")),(0,r.mdx)("h2",{id:"encryption-algorithm"},"Encryption algorithm"),(0,r.mdx)("p",null,"We recommend using the AES-256 encryption algorithm, which requires a 32-character encryption key, an initialization vector, and a 16-bit authentication tag. AES-256 is a resilient encryption algorithm that is nearly impossible to brute force."),(0,r.mdx)("p",null,"The ",(0,r.mdx)("a",{parentName:"p",href:"https://github.com/adobe/amazon-sales-channel-app-builder/blob/main/actions-src/shared/security/encrypt.ts"},(0,r.mdx)("inlineCode",{parentName:"a"},"encrypt.ts"))," file provides encryption and decryption functions, as shown below:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-typescript"},"import { createCipheriv, createDecipheriv } from 'node:crypto';\nimport { DecryptionError } from './decryptionError';\n \ninterface CipherArgs {\n  key: Buffer;\n  iv: Buffer;\n}\n \nconst ALGORITHM = 'aes-256-gcm';\n \nexport function encrypt(text: string, cipherArgs: CipherArgs): string {\n  const { key, iv } = cipherArgs;\n \n  const cipher = createCipheriv(ALGORITHM, key, iv);\n  let encrypted = cipher.update(text);\n  encrypted = Buffer.concat([encrypted, cipher.final()]);\n \n  const authTag = cipher.getAuthTag().toString('hex');\n  return [encrypted.toString('hex'), authTag].join(':');\n}\n \nexport function decrypt(text: string, cipherArgs: CipherArgs): string {\n  const [encryptedData, authTag] = text.split(':');\n \n  const { key, iv } = cipherArgs;\n  const encryptedText = Buffer.from(encryptedData, 'hex');\n  try {\n    const decipher = createDecipheriv(ALGORITHM, key, iv);\n    decipher.setAuthTag(Buffer.from(authTag, 'hex'));\n    let decrypted = decipher.update(encryptedText);\n    decrypted = Buffer.concat([decrypted, decipher.final()]);\n \n    return decrypted.toString();\n  } catch {\n    throw new DecryptionError('Unable to decipher encrypted message');\n  }\n}\n")),(0,r.mdx)("h2",{id:"credentials-data-schema"},"Credentials Data Schema"),(0,r.mdx)("p",null,"Each data file is identified by the ",(0,r.mdx)("inlineCode",{parentName:"p"},"accountId")," parameter and contains the account's set of credentials required to access the Amazon API and other sensitive data that should be encrypted before being stored in the ",(0,r.mdx)("inlineCode",{parentName:"p"},"lib-file")," as a safety precaution."),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},(0,r.mdx)("inlineCode",{parentName:"p"},"amazonsp-credentials-<accountId>")," - Once saved, this ",(0,r.mdx)("inlineCode",{parentName:"p"},"string"),"-type blob will be an encrypted AES256 string containing the following structure:"),(0,r.mdx)("pre",{parentName:"li"},(0,r.mdx)("code",{parentName:"pre",className:"language-typescript"},"{\n  sellingPartnerAppClientId: string,\n  sellingPartnerAppClientSecret: string,\n  awsAccessKeyId: string,\n  awsSecretAccessKey: string,\n  awsSellingPartnerRole: string,\n}\n"))),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},(0,r.mdx)("inlineCode",{parentName:"p"},"amazonsp-refreshToken-<accountId>")," - This ",(0,r.mdx)("inlineCode",{parentName:"p"},"string"),"-type blob contains the Amazon refresh token."))),(0,r.mdx)("h2",{id:"credentials-storage-code-samples"},"Credentials storage code samples"),(0,r.mdx)("p",null,"The following code block shows the helper class that receives the encryption key and initialization vector. The class then uses this data to evoke the methods that either encrypt or decrypt the passed data, using the algorithms previously shown."),(0,r.mdx)("p",null,"For local development, the encryption key and initialization vector can be stored in the ",(0,r.mdx)("inlineCode",{parentName:"p"},".env")," file. Since this file cannot be uploaded to GitHub, we recommend that you store these secrets as GitHub secrets. Furthermore, AES-256 best practices recommend that you use a different initialization vector for each encryption."),(0,r.mdx)("p",null,"The ",(0,r.mdx)("a",{parentName:"p",href:"https://github.com/adobe/amazon-sales-channel-app-builder/blob/main/actions-src/shared/security/credentialsEncryptionHelper.ts"},(0,r.mdx)("inlineCode",{parentName:"a"},"CredentialsEncryptionHelper"))," class provides encryption and decryption methods."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-typescript"},"import { randomBytes } from 'node:crypto';\nimport { decrypt, encrypt } from './encrypt';\nimport Credentials = AmazonSalesChannel.Model.Credentials;\n \nexport class CredentialsEncryptionHelper {\n  private readonly key: Buffer;\n \n  private readonly iv: Buffer;\n \n  constructor(key: string, iv?: string) {\n    this.key = Buffer.from(key);\n \n    this.iv = iv === undefined || iv === '' ? randomBytes(16) : Buffer.from(iv);\n  }\n \n  public encryptCredentials(credentials: Credentials): string {\n    return this.encrypt(JSON.stringify(credentials));\n  }\n \n  public decryptCredentials(text: string): Credentials {\n    return JSON.parse(this.decrypt(text)) as unknown as Credentials;\n  }\n \n  public encrypt(text: string): string {\n    return encrypt(text, { key: this.key, iv: this.iv });\n  }\n \n  public decrypt(text: string): string {\n    return decrypt(text, { key: this.key, iv: this.iv });\n  }\n}\n")),(0,r.mdx)("h3",{id:"encryption-example"},"Encryption example"),(0,r.mdx)("p",null,"In ",(0,r.mdx)("a",{parentName:"p",href:"https://github.com/adobe/amazon-sales-channel-app-builder/blob/main/actions-src/api/account/runtime/storeCredentials.ts"},"this example"),", we initialize the encryption helper with the encryption key and initialization vector. Data is encrypted and stored in the database using the ",(0,r.mdx)("inlineCode",{parentName:"p"},"accountId")," as the identifier."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-typescript"},"const credentialsRepository = new CredentialsRepository(logger);\n \nconst credentialsEncryptionHelper = new CredentialsEncryptionHelper(\n  params.ENCRYPTION_KEY,\n  params.ENCRYPTION_IV,\n);\nconst encryptedCredentials = credentialsEncryptionHelper.encryptCredentials({\n  sellingPartnerAppClientId: params.sellingPartnerAppClientId,\n  sellingPartnerAppClientSecret: params.sellingPartnerAppClientSecret,\n  awsAccessKeyId: params.awsAccessKeyId,\n  awsAccessKeySecret: params.awsSecretAccessKey,\n  awsSellingPartnerRole: params.awsSellingPartnerRole,\n});\n \nawait credentialsRepository.saveCredentials(\n  accounts[params.accountId].id,\n  encryptedCredentials,\n);\n")),(0,r.mdx)("h3",{id:"decryption-example"},"Decryption example"),(0,r.mdx)("p",null,"In ",(0,r.mdx)("a",{parentName:"p",href:"https://github.com/adobe/amazon-sales-channel-app-builder/blob/main/actions-src/api/account/runtime/getCredentials.ts"},"this example"),", we retrieve the list of accounts, and the encryption helper is initialized with the encryption key and initialization vector."),(0,r.mdx)("p",null,"The account's credentials are retrieved from the ",(0,r.mdx)("inlineCode",{parentName:"p"},"lib-file")," storage system and decrypted using the encryption library."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-typescript"},"const accountRepository = new AccountRepository(logger);\nconst accounts: Accounts = await accountRepository.getAccounts();\n \nif (accounts[params.accountId] === undefined) {\n  throw new NotFoundError(`Account ${params.accountId} was not found}`);\n}\n \nconst credentialsEncryptionHelper = new CredentialsEncryptionHelper(\n  params.encryptionKey,\n  params.encryptionIv,\n);\n \nconst credentialsRepository = new CredentialsRepository(logger);\n \nconst encryptedCredentials = await credentialsRepository.getCredentials(\n  accounts[params.accountId].id,\n);\nconst credentials: Credentials =\n  credentialsEncryptionHelper.decryptCredentials(encryptedCredentials);\n")))}l.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-app-development-best-practices-credentials-md-fe803b75808116064f17.js.map