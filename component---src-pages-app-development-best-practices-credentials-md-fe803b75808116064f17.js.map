{"version":3,"file":"component---src-pages-app-development-best-practices-credentials-md-fe803b75808116064f17.js","mappings":"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","sources":["webpack://commerce-extensibility/./src/pages/app-development/best-practices/credentials.md"],"sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsxRuntime classic */\n/* @jsx mdx */\nimport DefaultLayout from \"/home/runner/work/commerce-extensibility/commerce-extensibility/node_modules/@adobe/gatsby-theme-aio/src/components/MDXFilter/index.js\";\nexport const _frontmatter = {};\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <h1 {...{\n      \"id\": \"credentials-management\"\n    }}>{`Credentials management`}</h1>\n    <p>{`App Builder is an excellent framework for building integrations that connect Commerce to 3rd-party systems like Amazon or ERPs. These systems often require credentials to support your application to securely communicate and update them.`}</p>\n    <p>{`The Amazon Sales Channel app requires credentials and secrets to perform certain actions and interact with the Amazon API. These items must be changed every 180 days to comply with Amazon standards, and they could be updated in runtime. Therefore, creating a static set of credentials is not an option.`}</p>\n    <p>{`This topic describes the method the development team used to safely store these credentials in a way that allows for easy updating when necessary.`}</p>\n    <h2 {...{\n      \"id\": \"use-case\"\n    }}>{`Use case`}</h2>\n    <p>{`The development team chose to implement a cypher algorithm to safely store and retrieve these credentials. This algorithm encrypts the credentials of each store using a unique vector that is randomly generated when the store is created.`}</p>\n    <p>{`The merchant enters credentials and secrets when creating a new store through the Admin using the `}<strong parentName=\"p\">{`Add Amazon Store`}</strong>{` menu.`}</p>\n    <p><span parentName=\"p\" {...{\n        \"className\": \"gatsby-resp-image-wrapper\",\n        \"style\": {\n          \"position\": \"relative\",\n          \"display\": \"block\",\n          \"marginLeft\": \"auto\",\n          \"marginRight\": \"auto\",\n          \"maxWidth\": \"1280px\"\n        }\n      }}>{`\n      `}<span parentName=\"span\" {...{\n          \"className\": \"gatsby-resp-image-background-image\",\n          \"style\": {\n            \"paddingBottom\": \"123.75%\",\n            \"position\": \"relative\",\n            \"bottom\": \"0\",\n            \"left\": \"0\",\n            \"display\": \"block\",\n            \"transition\": \"opacity 0.5s 0.5s\",\n            \"pointerEvents\": \"none\"\n          }\n        }}></span>{`\n  `}<picture parentName=\"span\">{`\n          `}<source parentName=\"picture\" {...{\n            \"srcSet\": [\"/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/5530d/add-amazon-sales-channel.webp 320w\", \"/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/0c8fb/add-amazon-sales-channel.webp 640w\", \"/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/94b1e/add-amazon-sales-channel.webp 1280w\", \"/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/b2fee/add-amazon-sales-channel.webp 1282w\"],\n            \"sizes\": \"(max-width: 1280px) 100vw, 1280px\",\n            \"type\": \"image/webp\"\n          }}></source>{`\n          `}<source parentName=\"picture\" {...{\n            \"srcSet\": [\"/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/dd4a7/add-amazon-sales-channel.png 320w\", \"/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/0f09e/add-amazon-sales-channel.png 640w\", \"/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/bbbf7/add-amazon-sales-channel.png 1280w\", \"/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/018c1/add-amazon-sales-channel.png 1282w\"],\n            \"sizes\": \"(max-width: 1280px) 100vw, 1280px\",\n            \"type\": \"image/png\"\n          }}></source>{`\n          `}<img parentName=\"picture\" {...{\n            \"className\": \"gatsby-resp-image-image\",\n            \"src\": \"/commerce-extensibility/static/989b6659cf28dd84b5d8351980388d0e/bbbf7/add-amazon-sales-channel.png\",\n            \"alt\": \"Add Amazon Sales Channel form\",\n            \"title\": \"Add Amazon Sales Channel form\",\n            \"loading\": \"lazy\",\n            \"style\": {\n              \"width\": \"100%\",\n              \"height\": \"100%\",\n              \"margin\": \"0\",\n              \"verticalAlign\": \"middle\",\n              \"position\": \"absolute\",\n              \"opacity\": \"0\",\n              \"transition\": \"opacity 0.5s\",\n              \"color\": \"inherit\",\n              \"boxShadow\": \"inset 0px 0px 0px 400px none\",\n              \"top\": \"0\",\n              \"left\": \"0\"\n            }\n          }}></img>{`\n        `}</picture>{`\n    `}</span></p>\n    <p>{`Once the merchant completes the form, an action is triggered to randomly generate an initialization vector specific to the new account and to store the account information. It's important that the initialization vector is generated in the backend so that it's not visible from the UI.`}</p>\n    <p>{`This vector is then used in another action that encrypts the credentials and stores them in the `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/adobe/aio-lib-files\"\n      }}><inlineCode parentName=\"a\">{`lib-file`}</inlineCode>{` storage system`}</a>{`. To use or update the credentials, they must be retrieved from `}<inlineCode parentName=\"p\">{`lib-file`}</inlineCode>{` and decrypted with the same vector used for encryption.`}</p>\n    <p>{`The following diagram describes the generic flow of the credential storage and encryption process.`}</p>\n    <p><span parentName=\"p\" {...{\n        \"className\": \"gatsby-resp-image-wrapper\",\n        \"style\": {\n          \"position\": \"relative\",\n          \"display\": \"block\",\n          \"marginLeft\": \"auto\",\n          \"marginRight\": \"auto\",\n          \"maxWidth\": \"1243px\"\n        }\n      }}>{`\n      `}<span parentName=\"span\" {...{\n          \"className\": \"gatsby-resp-image-background-image\",\n          \"style\": {\n            \"paddingBottom\": \"62.18749999999999%\",\n            \"position\": \"relative\",\n            \"bottom\": \"0\",\n            \"left\": \"0\",\n            \"display\": \"block\",\n            \"transition\": \"opacity 0.5s 0.5s\",\n            \"pointerEvents\": \"none\"\n          }\n        }}></span>{`\n  `}<picture parentName=\"span\">{`\n          `}<source parentName=\"picture\" {...{\n            \"srcSet\": [\"/commerce-extensibility/static/eb9bde6faee475e008ef9c8f7cce25cf/5530d/credentials-flow.webp 320w\", \"/commerce-extensibility/static/eb9bde6faee475e008ef9c8f7cce25cf/0c8fb/credentials-flow.webp 640w\", \"/commerce-extensibility/static/eb9bde6faee475e008ef9c8f7cce25cf/f2a99/credentials-flow.webp 1243w\"],\n            \"sizes\": \"(max-width: 1243px) 100vw, 1243px\",\n            \"type\": \"image/webp\"\n          }}></source>{`\n          `}<source parentName=\"picture\" {...{\n            \"srcSet\": [\"/commerce-extensibility/static/eb9bde6faee475e008ef9c8f7cce25cf/dd4a7/credentials-flow.png 320w\", \"/commerce-extensibility/static/eb9bde6faee475e008ef9c8f7cce25cf/0f09e/credentials-flow.png 640w\", \"/commerce-extensibility/static/eb9bde6faee475e008ef9c8f7cce25cf/2c0f3/credentials-flow.png 1243w\"],\n            \"sizes\": \"(max-width: 1243px) 100vw, 1243px\",\n            \"type\": \"image/png\"\n          }}></source>{`\n          `}<img parentName=\"picture\" {...{\n            \"className\": \"gatsby-resp-image-image\",\n            \"src\": \"/commerce-extensibility/static/eb9bde6faee475e008ef9c8f7cce25cf/2c0f3/credentials-flow.png\",\n            \"alt\": \"Credentials storage and encryption flow\",\n            \"title\": \"Credentials storage and encryption flow\",\n            \"loading\": \"lazy\",\n            \"style\": {\n              \"width\": \"100%\",\n              \"height\": \"100%\",\n              \"margin\": \"0\",\n              \"verticalAlign\": \"middle\",\n              \"position\": \"absolute\",\n              \"opacity\": \"0\",\n              \"transition\": \"opacity 0.5s\",\n              \"color\": \"inherit\",\n              \"boxShadow\": \"inset 0px 0px 0px 400px none\",\n              \"top\": \"0\",\n              \"left\": \"0\"\n            }\n          }}></img>{`\n        `}</picture>{`\n    `}</span></p>\n    <h2 {...{\n      \"id\": \"encryption-algorithm\"\n    }}>{`Encryption algorithm`}</h2>\n    <p>{`We recommend using the AES-256 encryption algorithm, which requires a 32-character encryption key, an initialization vector, and a 16-bit authentication tag. AES-256 is a resilient encryption algorithm that is nearly impossible to brute force.`}</p>\n    <p>{`The `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/adobe/amazon-sales-channel-app-builder/blob/main/actions-src/shared/security/encrypt.ts\"\n      }}><inlineCode parentName=\"a\">{`encrypt.ts`}</inlineCode></a>{` file provides encryption and decryption functions, as shown below:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-typescript\"\n      }}>{`import { createCipheriv, createDecipheriv } from 'node:crypto';\nimport { DecryptionError } from './decryptionError';\n \ninterface CipherArgs {\n  key: Buffer;\n  iv: Buffer;\n}\n \nconst ALGORITHM = 'aes-256-gcm';\n \nexport function encrypt(text: string, cipherArgs: CipherArgs): string {\n  const { key, iv } = cipherArgs;\n \n  const cipher = createCipheriv(ALGORITHM, key, iv);\n  let encrypted = cipher.update(text);\n  encrypted = Buffer.concat([encrypted, cipher.final()]);\n \n  const authTag = cipher.getAuthTag().toString('hex');\n  return [encrypted.toString('hex'), authTag].join(':');\n}\n \nexport function decrypt(text: string, cipherArgs: CipherArgs): string {\n  const [encryptedData, authTag] = text.split(':');\n \n  const { key, iv } = cipherArgs;\n  const encryptedText = Buffer.from(encryptedData, 'hex');\n  try {\n    const decipher = createDecipheriv(ALGORITHM, key, iv);\n    decipher.setAuthTag(Buffer.from(authTag, 'hex'));\n    let decrypted = decipher.update(encryptedText);\n    decrypted = Buffer.concat([decrypted, decipher.final()]);\n \n    return decrypted.toString();\n  } catch {\n    throw new DecryptionError('Unable to decipher encrypted message');\n  }\n}\n`}</code></pre>\n    <h2 {...{\n      \"id\": \"credentials-data-schema\"\n    }}>{`Credentials Data Schema`}</h2>\n    <p>{`Each data file is identified by the `}<inlineCode parentName=\"p\">{`accountId`}</inlineCode>{` parameter and contains the account's set of credentials required to access the Amazon API and other sensitive data that should be encrypted before being stored in the `}<inlineCode parentName=\"p\">{`lib-file`}</inlineCode>{` as a safety precaution.`}</p>\n    <ul>\n      <li parentName=\"ul\">\n        <p parentName=\"li\"><inlineCode parentName=\"p\">{`amazonsp-credentials-<accountId>`}</inlineCode>{` - Once saved, this `}<inlineCode parentName=\"p\">{`string`}</inlineCode>{`-type blob will be an encrypted AES256 string containing the following structure:`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-typescript\"\n          }}>{`{\n  sellingPartnerAppClientId: string,\n  sellingPartnerAppClientSecret: string,\n  awsAccessKeyId: string,\n  awsSecretAccessKey: string,\n  awsSellingPartnerRole: string,\n}\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\"><inlineCode parentName=\"p\">{`amazonsp-refreshToken-<accountId>`}</inlineCode>{` - This `}<inlineCode parentName=\"p\">{`string`}</inlineCode>{`-type blob contains the Amazon refresh token.`}</p>\n      </li>\n    </ul>\n    <h2 {...{\n      \"id\": \"credentials-storage-code-samples\"\n    }}>{`Credentials storage code samples`}</h2>\n    <p>{`The following code block shows the helper class that receives the encryption key and initialization vector. The class then uses this data to evoke the methods that either encrypt or decrypt the passed data, using the algorithms previously shown.`}</p>\n    <p>{`For local development, the encryption key and initialization vector can be stored in the `}<inlineCode parentName=\"p\">{`.env`}</inlineCode>{` file. Since this file cannot be uploaded to GitHub, we recommend that you store these secrets as GitHub secrets. Furthermore, AES-256 best practices recommend that you use a different initialization vector for each encryption.`}</p>\n    <p>{`The `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/adobe/amazon-sales-channel-app-builder/blob/main/actions-src/shared/security/credentialsEncryptionHelper.ts\"\n      }}><inlineCode parentName=\"a\">{`CredentialsEncryptionHelper`}</inlineCode></a>{` class provides encryption and decryption methods.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-typescript\"\n      }}>{`import { randomBytes } from 'node:crypto';\nimport { decrypt, encrypt } from './encrypt';\nimport Credentials = AmazonSalesChannel.Model.Credentials;\n \nexport class CredentialsEncryptionHelper {\n  private readonly key: Buffer;\n \n  private readonly iv: Buffer;\n \n  constructor(key: string, iv?: string) {\n    this.key = Buffer.from(key);\n \n    this.iv = iv === undefined || iv === '' ? randomBytes(16) : Buffer.from(iv);\n  }\n \n  public encryptCredentials(credentials: Credentials): string {\n    return this.encrypt(JSON.stringify(credentials));\n  }\n \n  public decryptCredentials(text: string): Credentials {\n    return JSON.parse(this.decrypt(text)) as unknown as Credentials;\n  }\n \n  public encrypt(text: string): string {\n    return encrypt(text, { key: this.key, iv: this.iv });\n  }\n \n  public decrypt(text: string): string {\n    return decrypt(text, { key: this.key, iv: this.iv });\n  }\n}\n`}</code></pre>\n    <h3 {...{\n      \"id\": \"encryption-example\"\n    }}>{`Encryption example`}</h3>\n    <p>{`In `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/adobe/amazon-sales-channel-app-builder/blob/main/actions-src/api/account/runtime/storeCredentials.ts\"\n      }}>{`this example`}</a>{`, we initialize the encryption helper with the encryption key and initialization vector. Data is encrypted and stored in the database using the `}<inlineCode parentName=\"p\">{`accountId`}</inlineCode>{` as the identifier.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-typescript\"\n      }}>{`const credentialsRepository = new CredentialsRepository(logger);\n \nconst credentialsEncryptionHelper = new CredentialsEncryptionHelper(\n  params.ENCRYPTION_KEY,\n  params.ENCRYPTION_IV,\n);\nconst encryptedCredentials = credentialsEncryptionHelper.encryptCredentials({\n  sellingPartnerAppClientId: params.sellingPartnerAppClientId,\n  sellingPartnerAppClientSecret: params.sellingPartnerAppClientSecret,\n  awsAccessKeyId: params.awsAccessKeyId,\n  awsAccessKeySecret: params.awsSecretAccessKey,\n  awsSellingPartnerRole: params.awsSellingPartnerRole,\n});\n \nawait credentialsRepository.saveCredentials(\n  accounts[params.accountId].id,\n  encryptedCredentials,\n);\n`}</code></pre>\n    <h3 {...{\n      \"id\": \"decryption-example\"\n    }}>{`Decryption example`}</h3>\n    <p>{`In `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/adobe/amazon-sales-channel-app-builder/blob/main/actions-src/api/account/runtime/getCredentials.ts\"\n      }}>{`this example`}</a>{`, we retrieve the list of accounts, and the encryption helper is initialized with the encryption key and initialization vector.`}</p>\n    <p>{`The account's credentials are retrieved from the `}<inlineCode parentName=\"p\">{`lib-file`}</inlineCode>{` storage system and decrypted using the encryption library.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-typescript\"\n      }}>{`const accountRepository = new AccountRepository(logger);\nconst accounts: Accounts = await accountRepository.getAccounts();\n \nif (accounts[params.accountId] === undefined) {\n  throw new NotFoundError(\\`Account \\${params.accountId} was not found}\\`);\n}\n \nconst credentialsEncryptionHelper = new CredentialsEncryptionHelper(\n  params.encryptionKey,\n  params.encryptionIv,\n);\n \nconst credentialsRepository = new CredentialsRepository(logger);\n \nconst encryptedCredentials = await credentialsRepository.getCredentials(\n  accounts[params.accountId].id,\n);\nconst credentials: Credentials =\n  credentialsEncryptionHelper.decryptCredentials(encryptedCredentials);\n`}</code></pre>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"names":["_frontmatter","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","props","mdxType","parentName","isMDXComponent"],"sourceRoot":""}